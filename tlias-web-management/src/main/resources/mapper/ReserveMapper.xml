<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.itheima.mapper.ReserveMapper">
    <delete id="deleteByIds">
        delete from  reserve
        where id in
        <foreach collection="ids" item="id" separator="," open="(" close=")">
            #{id}
        </foreach>
    </delete>
    <!--    根据id查询用户预约信息，使用resultMap进行结果集的封装 -->
    <select id="userList" resultMap="userReserveMap">
        SELECT
            d.name name,
            r.id id,
            r.d_id d_id,
            r.user_id userId,
            r.status status,
            r.appoint_time appointTime,
            r.reason reason,
            r.diet_advice dietAdvise,
            r.exercise_advice exerciseAdvise,
            r.medication_advice medicationAdvise
        FROM reserve r left join doctor d on r.d_id = d.id
        where r.user_id=#{id}
    </select>
<!--    property:属性名，column:数据库字段名-->
    <resultMap id="userReserveMap" type="com.itheima.pojo.Reserve">
        <id property="id" column="id"/>
        <result property="userId" column="userId"/>
        <result property="did" column="d_id"/>
        <result property="dName" column="name"/>
        <result property="status" column="status"/>
        <result property="appointTime" column="appointTime"/>
        <result property="reason" column="reason"/>
        <result property="dietAdvise" column="diet_advice"/>
        <result property="exerciseAdvise" column="exercise_advice"/>
        <result property="medicationAdvise" column="medication_advice"/>
    </resultMap>

<!--    医生查看预约的用户信息-->
    <select id="doctorList" resultMap="doctorReserveMap">
        SELECT
            u.read_name name,
            r.id id
            r.d_id dId,
            r.status status,
            r.appoint_time appointTime,
            r.reason reason,
            r.diet_advice dietAdvise,
            r.exercise_advice exerciseAdvise,
            r.medication_advice medicationAdvise
        FROM reserve r left join user_info u on r.user_id = u.id
        where u.id=#{id}
    </select>

    <resultMap id="doctorReserveMap" type="com.itheima.pojo.Reserve">
        <id property="id" column="id"/>
        <result property="did" column="dId"/>
        <result property="userId" column="userId"/>
        <result property="userName" column="name"/>
        <result property="status" column="status"/>
        <result property="appointTime" column="appointTime"/>
        <result property="reason" column="reason"/>
        <result property="dietAdvise" column="diet_advice"/>
        <result property="exerciseAdvise" column="exercise_advice"/>
        <result property="medicationAdvise" column="medication_advice"/>
    </resultMap>
<!--    根据id查询用户预约信息，使用resultMap进行结果集的封装 -->
    <select id="adviceListById" resultMap="adviceReserveMap">
        SELECT
            r.id id,
            r.d_id dId,
            r.user_id userId,
            d.name dname,
            d.dept dept,
            r.appoint_time appointTime,
            r.diet_advice dietAdvise,
            r.exercise_advice exerciseAdvise,
            r.medication_advice medicationAdvise
        FROM reserve r left join doctor d on r.d_id = d.id left join user_info u on r.user_id = u.id
        where r.user_id=#{id} and r.status=#{status}
    </select>
    <!--    property:属性名，column:数据库字段名-->
    <resultMap id="adviceReserveMap" type="com.itheima.pojo.Reserve">
            <id property="id" column="id"/>
            <result property="did" column="dId"/>
            <result property="userId" column="userId"/>
            <result property="dName" column="dname"/>
            <result property="dept" column="dept"/>
            <result property="appointTime" column="appointTime"/>
            <result property="dietAdvise" column="dietAdvise"/>
            <result property="exerciseAdvise" column="exerciseAdvise"/>
            <result property="medicationAdvise" column="medicationAdvise"/>
    </resultMap>

    <!--    查看所有的预约记录-->
    <select id="list" resultMap="reserveMap">
        SELECT
            r.id id,
            r.d_id dId,
            r.user_id userId,
            u.name userName,
            d.name dname,
            d.dept dept,
            r.appoint_time appointTime,
            r.diet_advice dietAdvise,
            r.exercise_advice exerciseAdvise,
            r.medication_advice medicationAdvise
        FROM reserve r left join doctor d on r.d_id = d.id left join user_info u on r.user_id = u.id
    </select>
    <select id="listPage" resultMap="reserveMap">
        select
            r.id id,
            r.d_id dId,
            r.user_id userId,
            r.appoint_time appointTime,
            r.update_time updateTime,
            r.status status,
            r.reason reason,
            r.diet_advice dietAdvise,
            r.exercise_advice exerciseAdvise,
            r.medication_advice medicationAdvise,
            d.name dname,u.name userName,d.dept dept from reserve r left join doctor d on r.d_id = d.id left join user_info u on r.user_id = u.id
        <where>
            <if test="userId!= null and userId!= ''">
                r.user_id = #{userId}
            </if>
            <if test="dId!= null and dId!= ''">
                and r.d_id = #{dId}
            </if>
            <if test="status!= null and status!= ''">
                and r.status = #{status}
            </if>
            <if test="begin!= null and end!= null">
                and r.appoint_time between #{begin} and #{end}
            </if>
        </where>
        order by r.update_time desc
    </select>
    <select id="getById" resultMap="reserveMap">
        SELECT
        r.id id,
        r.d_id dId,
        r.user_id userId,
        u.name userName,
        d.name dname,
        d.dept dept,
        r.status status,
        r.reason reason,
        r.appoint_time appointTime,
        r.update_time updateTime,
        r.diet_advice dietAdvise,
        r.exercise_advice exerciseAdvise,
        r.medication_advice medicationAdvise
        FROM reserve r left join doctor d on r.d_id = d.id left join user_info u on r.user_id = u.id
        where r.id = #{id}
    </select>
    <update id="update">
        update reserve
        <set>
            <if test="userId!= null and userId!= ''">user_id = #{userId},</if>
            <if test="did!= null and did!= ''">d_id = #{did},</if>
            <if test="status!= null and status!= ''">status = #{status},</if>
            <if test="reason!= null and reason!= ''">reason = #{reason},</if>
            <if test="dietAdvise!= null and dietAdvise!= ''">diet_advice = #{dietAdvise},</if>
            <if test="exerciseAdvise!= null and exerciseAdvise!= ''">exercise_advice = #{exerciseAdvise},</if>
            <if test="medicationAdvise!= null and medicationAdvise!= ''">medication_advice = #{medicationAdvise},</if>
            <if test="appointTime!= null">appoint_time = #{appointTime},</if>
            <if test="updateTime!= null">update_time = #{updateTime}</if>
        </set>
        where id = #{id}
    </update>
    <!--    property:属性名，column:数据库字段名-->
    <resultMap id="reserveMap" type="com.itheima.pojo.Reserve">
        <id property="id" column="id"/>
        <result property="did" column="dId"/>
        <result property="userId" column="userId"/>
        <result property="userName" column="userName"/>
        <result property="dName" column="dname"/>
        <result property="dept" column="dept"/>
        <result property="reason" column="reason"/>
        <result property="status" column="status"/>
        <result property="appointTime" column="appointTime"/>
        <result property="updateTime" column="updateTime"/>
        <result property="dietAdvise" column="dietAdvise"/>
        <result property="exerciseAdvise" column="exerciseAdvise"/>
        <result property="medicationAdvise" column="medicationAdvise"/>
    </resultMap>
</mapper>